# å‰ç«¯æ­£åœ¨ç¬‘ä½ ç„¡èƒ½ - Performance Check

é€™ç³»åˆ—ä¸»è¦æ¢è¨å‰ç«¯çš„æ•ˆèƒ½ï¼Œåˆ°åº•éœ€è¦é¡§æ…®æ•ˆèƒ½é¢é‚„æ˜¯åŠŸèƒ½é¢ï¼Œä¸€ç›´æ˜¯å‰ç«¯é ˜åŸŸå¾ˆæ‡Šæƒ±æŠ˜é¨°çš„äº‹æƒ…ã€‚æ­¤ç³»åˆ—æ˜¯ç‚ºäº†è®“å·¥ç¨‹å¸«èƒ½å¤ å¿«é€Ÿäº†è§£å‰ç«¯è©²æ³¨æ„çš„æ•ˆèƒ½é¢æœ‰å“ªäº›ï¼Œä»¥åŠå®ƒçš„é‹ä½œåŸç†ç­‰ã€‚

å› æ­¤ç¯‡æœ‰å¤ªå¤šèˆ‡ç¡¬é«”ç›¸é—œçš„æŠ€è¡“é¢ï¼Œæœ¬äººçš„æŠ€èƒ½æ¨¹æœ‰é™ï¼Œé›£å…æœƒæœ‰è³‡è¨ŠéŒ¯èª¤çš„éƒ¨åˆ†ï¼Œæ­¡è¿å¤§å®¶æå‡ºä¿®æ”¹ã€‚

## æ·ºæ·ºè«‡è«‡ JavaScript çš„è¨˜æ†¶é«” 
èº«ç‚ºå‰ç«¯å·¥ç¨‹å¸«ï¼Œæ‡‰è©²ä¸å¤ªè¨ˆè¼ƒJavaScriptå¼•æ“æ˜¯æ€éº¼è™•ç†**è¨˜æ†¶é«”åˆ†é…** `ï¼ˆMemory Allocationï¼‰` çš„éƒ¨åˆ†ï¼Œä¸åŒçš„JavaScriptå¼•æ“åœ¨è™•ç†è¨˜æ†¶é«”çš„éƒ¨åˆ†ä¹Ÿç•¥æœ‰ä¸åŒã€‚å› æœ‰ä¸€æ¬¡ä¸Šäº†æŸçŸ¥åè€å¸«çš„èª²ï¼Œè·Ÿè€å¸«äº¤æµå¾Œç™¼ç¾èˆ‡è‡ªå·±äº†è§£çš„è¨˜æ†¶é«”åˆ†é…æœ‰å·®ï¼Œæ‰€ä»¥ç¨å¾®æ·±å…¥ç ”ç©¶äº†ä¸€ä¸‹Chrome V8 å¼•æ“è™•ç†æ–¹å¼ï¼ŒæŠŠäº†è§£çš„è¨˜éŒ„ä¸‹ä¾†ã€‚

åœ¨JavaScriptè£¡ï¼Œåœ¨é–‹å§‹ç”¢ç”Ÿ**ç‰©ä»¶**æ™‚ï¼ˆæ­¤`ç‰©ä»¶`éå–®ç´”æŒ‡JavaScriptè£¡çš„ç‰©ä»¶å‹åˆ¥ï¼›å®ƒé‚„åŒ…å« `boolean` , `string` , `array` ç­‰å‹åˆ¥ï¼‰éƒ½æœƒè¢«è³¦äºˆè¨˜æ†¶é«”ç©ºé–“ï¼Œç„¶è€Œå› ç‚ºæœ‰**åƒåœ¾å›æ”¶** `ï¼ˆGarbage Collectionï¼‰` ï¼ˆå¾ŒçºŒç°¡ç¨± GCï¼‰æ©Ÿåˆ¶ï¼Œé€™äº›è¨˜æ†¶é«”å°‡æœƒ`è‡ªå‹•`è¢«æ¸…é™¤ï¼Œé–‹ç™¼è€…ä¸éœ€ç‰¹åˆ¥å»å°‡åŸæœ¬è¢«ä½”æ“šçš„è¨˜æ†¶é«”åšæ‰‹å‹•çš„æ¸…é™¤ã€‚

### è¨˜æ†¶é«”çš„ç”Ÿå‘½é€±æœŸ LifeCycle
é›–ç„¶é€éGCæ©Ÿåˆ¶ï¼Œè¨˜æ†¶é«”æœƒ`è‡ªå‹•`é‡‹æ”¾ï¼Œä½†é€™ä¸ä»£è¡¨é–‹ç™¼è€…ä¸æœƒé‡åˆ°è¨˜æ†¶é«”éè¼‰å•é¡Œï¼Œä¾‹å¦‚é–‹ç™¼è€…å¯«äº†éå¤šçš„äº‹ä»¶ç›£è½ä½†å»å¿˜äº†ç§»é™¤ç­‰ï¼Œå°è‡´**è¨˜æ†¶é«”æ´©æ¼** `ï¼ˆMemory Leakï¼‰` çš„å•é¡Œã€‚

è¦é¿å…é€™å•é¡Œï¼Œæˆ‘å€‘é¦–å…ˆå¿…é ˆäº†è§£ï¼Œå¤§è‡´ä¸Šéƒ½æœ‰é€™ä¸‰å€‹éšæ®µï¼š

> <center> è³¦äºˆè¨˜æ†¶é«” > ä½¿ç”¨è¨˜æ†¶é«” > é‡‹æ”¾è¨˜æ†¶é«” </center>

1. **è³¦äºˆè¨˜æ†¶é«”`ï¼ˆAllocationï¼‰`**ï¼šå®£å‘Šè®Šæ•¸æˆ–è³¦äºˆåˆå§‹åŒ–å€¼ã€å‡½å¼å‘¼å«å¼ `let date = new Date();`ï¼Œå³è¢«è³¦äºˆè¨˜æ†¶é«”ç©ºé–“
2. **ä½¿ç”¨è¨˜æ†¶é«” `ï¼ˆUseï¼‰`** ï¼š æŒ‡è®€å–/ä½¿ç”¨ï¼ˆ**Read**ï¼‰å®ƒæˆ–ä¿®æ”¹/å¯«å…¥ï¼ˆ**Write**ï¼‰è®Šæ•¸ã€æˆ–åœ¨å‡½å¼ä¸­å¸¶å…¥åƒæ•¸ã€‚
3. **é‡‹æ”¾è¨˜æ†¶é«” `ï¼ˆReleaseï¼‰`** ï¼š ç•¶è®Šæ•¸æˆ–å±¬æ€§æ²’æœ‰è¢«ä½¿ç”¨ã€**æŒ‡å‘ `ï¼ˆpointingï¼‰`** ã€ **åƒè€ƒ `ï¼ˆreferenceï¼‰`** æ™‚ï¼Œå³é€é GC æŠŠè³¦äºˆçš„è¨˜æ†¶é«”ä½ç½®çµ¦é‡‹æ”¾ã€‚

> ğŸ’¡ document.getElementById('id') - ä½¿ç”¨ `document` ç‰©ä»¶è£¡çš„æ–¹æ³•ä¹Ÿå±¬è³¦äºˆè¨˜æ†¶é«”çš„éšæ®µ 

> âš ï¸ åœ¨ä¸»æµç¨‹å¼èªè¨€ä¸­ï¼Œæ¬²é‡‹æ”¾è¨˜æ†¶é«”ï¼Œå¯é€éè³¦äºˆ `null` æˆ– `delete obj.myProperty` å³å¯é”åˆ°é‡‹æ”¾è¨˜æ†¶é«”çš„æ•ˆæœï¼Œä½†åœ¨JavaScriptè£¡é€™ä¸¦éçµ•å°ï¼Œç­‰ç­‰åœ¨èªª `åƒè€ƒ` æ™‚æœƒå†ç´°èªªã€‚

```javascript
let a = '1'; //è¨˜æ†¶é«”ä½ç½® 0xff11
let b = '2'; //è¨˜æ†¶é«”ä½ç½® 0xff22
let c = {a: 1}; //è¨˜æ†¶é«”ä½ç½® 0xff33
let d = c; //æŒ‡å‘åŒä¸€å€‹è¨˜æ†¶é«”ä½ç½® 0xff33
a = b; // è¨˜æ†¶é«”ä½ç½® 0xff11 å› æ²’æœ‰ä½¿ç”¨è€Œè¢«é‡‹æ”¾ï¼Œä½†åŒæ™‚å»ºç«‹äº† 0xff44 è¨˜æ†¶é«”ä½ç½®
```
ä¸Šè¿°ä¾‹å­ä¸­ï¼Œå›  `b` è£¡çš„å€¼ `2` è³¦äºˆ `a`, ä½¿ç”¨äº†`call by value` çš„åƒæ•¸å‚³éæ–¹å¼æ‹·è²ä¸€ä»½æ–°çš„ `2`ï¼Œå› æ­¤åŸæœ¬çš„ `1` æ‰€ä½”ç”¨çš„è¨˜æ†¶é«”æ²’è¢«ä½¿ç”¨å¾Œå³è¢«é‡‹æ”¾å‡ºä¾†ã€‚åœ¨é€™ç³»åˆ—æˆ‘åªé‡å°è¨˜æ†¶é«”ç®¡ç†è€Œä¸æœƒç´°è«‡JavaScriptçš„åƒæ•¸å‚³éæ–¹å¼ï¼Œæœ‰èˆˆè¶£çš„å¯ä»¥åƒè€ƒèƒ¡ç«‹æ’°å¯«çš„ [æ·±å…¥æ¢è¨ JavaScript ä¸­çš„åƒæ•¸å‚³éï¼šcall by value é‚„æ˜¯ referenceï¼Ÿ](https://blog.techbridge.cc/2018/06/23/javascript-call-by-value-or-reference/)ã€‚

ç”±æ­¤å¯è¦‹ï¼Œåœ¨è¨˜æ†¶é«”çš„ç”Ÿå‘½é€±æœŸä¸‰å€‹éšæ®µä¸­ï¼Œé‡‹æ”¾è¨˜æ†¶é«”æœƒæ˜¯æ•´å€‹è¨˜æ†¶é«”ç®¡ç†éç¨‹ä¸­æœ€è¤‡é›œçš„ä¸€é¢ã€‚å› GCæ©Ÿåˆ¶ï¼ŒJavaScriptå¼•æ“éœ€è¦çŸ¥é“å“ªäº›è®Šæ•¸æ˜¯æ²’è¢«æŒ‡å‘/åƒè€ƒæˆ–æ˜¯å¾ŒçºŒä¸æœƒå†ç”¨åˆ°çš„ï¼Œæ‰æœƒå°‡å®ƒçµ¦é‡‹æ”¾å‡ºä¾†ã€‚æ¥ä¸‹ä¾†ä¾†çœ‹çœ‹GCæ˜¯æ€éº¼åˆ¤å®šè¨˜æ†¶é«”è©²é‡‹æ”¾èˆ‡å¦ã€‚

### `Garbage Collection` æ¼”ç®—æ³•
GCè¦æ€éº¼åˆ¤å®šè¨˜æ†¶é«”æ˜¯å¦è©²å­˜åœ¨ï¼Œä¾é ä»¥ä¸‹å…©ç¨®æ¼”ç®—æ³•ï¼š
1. **Reference-counting garbage collection åƒåœ¾å›æ”¶åƒè€ƒè¨ˆæ•¸**
2. **Mark-and-sweep algorithm æ¨™è¨˜å’Œæ¸…ç†æ¼”ç®—æ³•**

> ğŸ’¡ ä»¥ä¸Šä¸­è­¯å–è‡ªMDNä¸­æ–‡ç‰ˆï¼Œæ–‡å­—ä¸Šçš„ç¢ºçœ‹ä¸æ‡‚åœ¨å¹¹å˜›ï¼Œä¸‹é¢æœƒå¤§æ¦‚è§£é‡‹ä¸€ä¸‹è‹±æ–‡å­—é¢ä¸Šçš„æ„ç¾©ã€‚
#### Reference-counting garbage collection
æ„ç¾©ä¸Šæ˜¯æŒ‡ï¼š**`é€éåƒè€ƒæ•¸é‡ï¼ˆReferences availabilityï¼‰çš„è¨ˆç®—ä¾†åˆ¤å®šé€™è¨˜æ†¶é«”æ˜¯å¦è©²è¢«é‡‹æ”¾`**ï¼›åœ¨JavaScriptè¨˜æ†¶é«”ç®¡ç†æ¦‚å¿µä¸­ï¼Œå…¶ä¸­ä¸€å€‹è »é‡è¦çš„è§€å¿µæ˜¯ç‰©ä»¶çš„**æŒ‡å‘/åƒè€ƒ `ï¼ˆReference)`** ï¼›è©²ç‰©ä»¶æ˜¯å¦æœ‰è¢«æŸè®Šæ•¸åƒè€ƒï¼š

```javascript
let a = { user: 'kangw3n' }; //è¨˜æ†¶é«”ç«‹å³è¢«å»ºç«‹
```

ä¸Šè¿°çš„ä¾‹å­å»ºç«‹äº†ä¸€å€‹ç‰©ä»¶å±¬æ€§ `user` å’Œå€¼ç‚º `kangw3n` ä¸¦è³¦äºˆ `a` é€™å€‹è®Šæ•¸ä¸Šã€‚æˆ‘å€‘å¯ä»¥ç†è§£æˆï¼šæ­¤æ™‚è©²ç‰©ä»¶ `{ user: 'kangw3n' }` ç‰©ä»¶è¢« `æŒ‡å‘` åˆ°è®Šæ•¸ `a` ä¸Šã€‚

```javascript
a = { user: 'kangw3n2' };
```

æ¥ä¸‹ä¾†æˆ‘å€‘æŠŠ `a` çš„å€¼è³¦äºˆå…¶ä»–å€¼ `{ user: 'kangw3n2' }` , æ³¨æ„é€™è£¡æ˜¯ç”¨**è¦†è“‹ç‰©ä»¶**çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯ `a.user = 'kangw3n2'` çš„æ–¹å¼ä¿®æ”¹ã€‚æ­¤æ™‚æŸå€‹æŒ‡å‘æ¶ˆå¤±äº†ï¼Œé‚£å°±æ˜¯ `{ user: 'kangw3n' }` ç‰©ä»¶ã€‚
 
ç•¶ç‰©ä»¶æ²’æœ‰è¢«ä»»ä½•ç‰©ä»¶çµ¦æŒ‡å‘/åƒè€ƒæ™‚ï¼Œè©²ç‰©ä»¶å±¬æ–¼"å¯ä»¥è¢«å›æ”¶çš„åƒåœ¾" `garbage collectible`ï¼Œå³ç­‰å¾…è¢«å›æ”¶çš„ç‰©ä»¶ï¼Œä»¥ä¸Šé¢çš„ä¾‹å­ç‰©ä»¶ `{ user: 'kangw3n2' }` è¨˜æ†¶é«”ä½ç½®å³æˆç‚º"å¯ä»¥è¢«å›æ”¶çš„åƒåœ¾"ã€‚

å¾å…©è¡Œç¨‹å¼å¯ä»¥çœ‹åˆ°ï¼Œå›  `{ user: 'kangw3n2' }` æ˜¯ç„¡æ³•åˆ°é” `ï¼ˆunreachableï¼‰` çš„æŒ‡å‘ï¼Œæ‰€ä»¥åœ¨`åƒåœ¾å›æ”¶åƒè€ƒè¨ˆæ•¸`æ©Ÿåˆ¶çš„èªçŸ¥ä¸Šæ²’æœ‰åƒè€ƒçš„ç‰©ä»¶å³å¯ä»¥è¢«å›æ”¶é‡‹æ”¾äº†ã€‚

`åƒåœ¾å›æ”¶åƒè€ƒè¨ˆæ•¸`å°±æ˜¯ä¾æ“šé€™é‚è¼¯åœ¨é‹è¡Œï¼Œä½†æ˜¯åœ¨è¤‡é›œä¸€äº›çš„ä¾‹å­æˆ–è¨±æœƒæœ‰ç„æ©Ÿï¼Œå¾€ä¸‹å†çœ‹ä¸€å€‹ä¾‹å­ï¼Œè‹¥ç‰©ä»¶è¢«åƒè€ƒäº†å‘¢ï¼Ÿ
```javascript
let a = { user: 'kangw3n'};
let b = a;
```
æ­¤æ™‚ç‰©ä»¶ `{ user: 'kangw3n'}` ç‰©ä»¶è¢« `æŒ‡å‘` åˆ° `a` ä¸Šï¼Œ`b` ä¹Ÿåƒè€ƒäº† `a` ã€‚å› JavaScriptç‰©ä»¶æ˜¯åƒè€ƒå‹åˆ¥ `ï¼ˆreferences typeï¼‰` ï¼Œæ‰€ä»¥JavaScriptä¸æœƒé‡å° `b` é–‹å•Ÿæ–°çš„ä¸€å€‹ç‰©ä»¶è¨˜æ†¶é«”ï¼Œå³æŠŠ `{ user: 'kangw3n' }` æŒ‡å‘åˆ°  `a` å’Œ `b` è®Šæ•¸ä¸Šã€‚

è‹¥å°‡ `a` å…§çš„å±¬æ€§å€¼ä¿®æ”¹ï¼š

```javascript
a.user: 'kangw3n2';
```
æ­¤æ™‚ `a` å’Œ `b` çš„å€¼çš†ç‚º `{ user: 'kangw3n2' }`ï¼Œå› ç‚ºä»–å€‘éƒ½æŒ‡å‘åŒä¸€å€‹åƒè€ƒç‰©ä»¶ï¼Œæ‰€ä»¥åˆ©ç”¨å±¬æ€§è³¦å€¼ `Dot Notation` æ–¹å¼ä¿®æ”¹ä¸æœƒè®“ JavaScriptå¼•æ“ç”¢ç”Ÿç¬¬äºŒå€‹è¨˜æ†¶é«”ç©ºé–“ï¼Œä¹Ÿä¸æœƒå› ç‚ºæ²’æœ‰æŒ‡å‘è€Œå›æ”¶ä»»ä½•åƒåœ¾ã€‚

ä½†åœ¨JavaScriptè£¡é¢å¥‡æ€ªçš„äº‹æƒ…è »å¤šçš„ï¼š
```javascript
a = { user: 'kangw3n3' };
```
åŸå…ˆ `b` åƒè€ƒäº† `a`ï¼Œ ç•¶æ™‚çš„ `b` ç‚º `{ user: 'kangw3n2' }`ï¼Œç•¶ä¿®æ”¹æ•´å€‹ `a` æŒ‡å‘çš„ç‰©ä»¶ï¼Œæˆ–è¨±æœ‰äººæœƒèªç‚º `{ user: 'kangw3n2'}` é€™å€‹å€¼å› ç‚ºæ²’æœ‰è¢«æŒ‡å‘äº†ï¼Œæ‰€ä»¥è©²è¢«å›æ”¶ã€‚ä½†å¯¦éš›ä¸Šä¸¦ä¸æ˜¯é€™æ¨£ï¼Œæˆ‘å€‘ç”¨ä¸‹åˆ—ç¨‹å¼ç¢¼è§£é‡‹ä¸€ä¸‹ï¼š
```javascript
let a = { user: 'kangw3n' };
let b = a;

a.user = 'kangw3n2'; // a = b = { user: 'kangw3n2' }

a = { user: 'kangw3n3' }; 
// ç•¶åŸ·è¡Œé€™æ®µcodeçš„æ™‚å€™ï¼ŒJavaScriptå¼•æ“å›å»æœå°‹åŸæœ¬çš„å±¬æ–¼açš„ { user: 'kangw3n2' } æœ‰æ²’æœ‰è¢«å…¶ä»–è®Šæ•¸çµ¦åƒè€ƒï¼Œç›®å‰æˆ‘å€‘çŸ¥é“ b æ˜¯åƒè€ƒ a çš„ï¼Œæ‰€ä»¥å¿…é ˆä¿æœ‰åŸæœ¬çš„ { user: 'kangw3n2' } è³¦äºˆ b ä¸¦é–‹å•Ÿä¸€å€‹æ–°çš„è¨˜æ†¶é«”ï¼Œ a å‰‡è®Šæˆ { user: 'kangw3n3' } éš¸å±¬æ–¼å¦ä¸€è¨˜æ†¶é«”ç©ºé–“
```

æœ€å¾Œè‹¥æˆ‘å€‘æŠŠ `b` çš„å€¼ä¹ŸæŒ‡å‘ `a` çš„è©±ï¼ŒåŸæœ¬çš„ `{ user: 'kangw3n2' }` å› æ²’è¢«æŒ‡å‘æˆ–åƒè€ƒå°‡è¢«`åƒåœ¾å›æ”¶åƒè€ƒè¨ˆæ•¸`æ©Ÿåˆ¶èªå®šç‚º"å¯ä»¥è¢«å›æ”¶çš„åƒåœ¾"ã€‚

##### äº’ç›¸åƒè€ƒç”¢ç”Ÿçš„è¿´åœˆæ˜¯æ²’è¾¦æ³•è¢«å›æ”¶çš„ã€‚
```javascript
function cycle() {
  var a = {};
  var b = {};
  b.a = a;
  a.b = b;
  return {a, b}
}
cycle();
```
`åƒåœ¾å›æ”¶åƒè€ƒè¨ˆæ•¸`æ©Ÿåˆ¶æœ‰å€‹ç¼ºé™·æ˜¯ï¼Œç•¶ç‰©ä»¶å«æœ‰äº’ç›¸åƒè€ƒçš„è¿´åœˆï¼Œå®ƒå€‘æ˜¯ç„¡æ³•ç«‹å³è¢«å›æ”¶é‡‹æ”¾çš„ã€‚

ä¸Šé¢çš„ä¾‹å­ä¸­ç•¶ `cycle()` è¢«åŸ·è¡Œçš„å¾Œï¼Œå› ç‚º `a` å’Œ `b` äº’ç›¸æˆç‚ºäº†å°æ–¹çš„åƒè€ƒç‰©ä»¶ï¼Œé›–ç„¶ `cycle()` çµæŸå¾Œæœ¬æ‡‰å°‡å®ƒå€‘å…©å€‹æ¨™è¨˜ç‚º"å¯ä»¥è¢«å›æ”¶çš„åƒåœ¾"ï¼Œä½†å› ç‚º`åƒåœ¾å›æ”¶åƒè€ƒè¨ˆæ•¸`æ©Ÿåˆ¶çš„åŸç†ä¸Šï¼›è¢«åƒè€ƒçš„ç‰©ä»¶æ˜¯æ²’è¾¦æ³•å°‡å®ƒå€‘å›æ”¶çš„ï¼Œæ­¤æ™‚å°±æœƒå½¢æˆJavaScriptè£¡çš„è¨˜æ†¶é«”æ´©æ¼ï¼Œæ‰€ä»¥æ¯”è¼ƒå¥½çš„æ–¹å¼æ˜¯åšä¸€å€‹ç‰©ä»¶æ‹·è²çš„å‹•ä½œï¼Œå³æŠŠ `b.a = Object.assign({}, a)` æ–¹å¼è³¦äºˆ `b.a`ï¼Œå³å¯è§£é™¤äº’ç›¸åƒè€ƒçš„è¿´åœˆã€‚æˆ‘å€‘åœ¨é€™ç³»åˆ—ä¸æœƒè¨è«–æ‹·è²ç‰©ä»¶é€™éƒ¨åˆ†ï¼Œä½†é€™å¯ä»¥è§£æ±ºåƒè€ƒæ‰€å°è‡´çš„`åƒåœ¾å›æ”¶åƒè€ƒè¨ˆæ•¸`çš„ç¼ºé™·ã€‚

ä»¥ä¸Šæ¼”ç®—æ³•ç‚º`åƒåœ¾å›æ”¶åƒè€ƒè¨ˆæ•¸`ï¼Œç°¡è€Œè¨€ä¹‹å°±æ˜¯**æœ‰æŒ‡å‘å°±ä¸å›æ”¶ï¼Œæ²’æœ‰æŒ‡å‘å°±èªå®šç‚ºæ˜¯åƒåœ¾**ã€‚

#### Mark and Sweep æ¨™è¨˜å’Œæ¸…ç†æ¼”ç®—æ³•

ç‚ºäº†è§£æ±º`åƒåœ¾å›æ”¶åƒè€ƒè¨ˆæ•¸`æ©Ÿåˆ¶çš„ç¼ºé™·ï¼Œ`æ¨™è¨˜å’Œæ¸…ç†æ¼”ç®—æ³•`ä½¿ç”¨äº†å¦ä¸€å¥—é‚è¼¯ï¼šå³å°‹æ‰¾ç‰©ä»¶**æ˜¯å¦å¯åˆ°é” (reachable)**ã€‚

`æ¨™è¨˜å’Œæ¸…ç†æ¼”ç®—æ³•`å°‡ç¶“éä¸‰å€‹æ­¥é©Ÿï¼š

1. **å°‹æ‰¾ç’°å¢ƒä¸­çš„æ ¹ç›®éŒ„ `ï¼ˆRootsï¼‰`** ï¼Œåœ¨JavaScriptçš„ä¸–ç•Œè£¡ï¼Œæ ¹ç›®éŒ„æ˜¯`å…¨åŸŸè®Šæ•¸`ï¼Œ åœ¨ç€è¦½å™¨ç’°å¢ƒæ˜¯ `window` ç‰©ä»¶ è€Œåœ¨Nodeç’°å¢ƒå‰‡æ˜¯ `global` ç‰©ä»¶ã€‚
2. æ¼”ç®—æ³•å…ˆæª¢è¦–æ ¹ç›®éŒ„å’Œæ‰€æœ‰çš„å­éšå±¤å±¬æ€§ï¼Œä¸¦å°‡å®ƒå€‘æ¨™è­˜æˆ `active` å³é"å¯ä»¥è¢«å›æ”¶çš„åƒåœ¾"ï¼Œç›¸åæ²’è¾¦æ³•åˆ°é”çš„ç‰©ä»¶ç¯€é»å‰‡æ¨™è¨˜ç‚º"å¯ä»¥è¢«å›æ”¶çš„åƒåœ¾"ã€‚
3. å°‡è¢«æ¨™è¨˜ç‚º"å¯ä»¥è¢«å›æ”¶çš„åƒåœ¾"çš„ç¯€é»ç‰©ä»¶æ¸…é™¤ï¼ŒæŠŠè¨˜æ†¶é«”é‡‹æ”¾å‡ºä¾†ã€‚

![Image of Mark and Sweep](https://miro.medium.com/max/700/1*WVtok3BV0NgU95mpxk9CNg.gif)  
*å¼•ç”¨äº†sessionstackæ–‡ç« å…§çš„åœ–*

åƒç…§ä»¥ä¸‹çš„ä¾‹å­ï¼š
```javascript
var a = { a: 1 };
```
æˆ‘å€‘åœ¨ç€è¦½å™¨ F12é–‹ç™¼ç’°å¢ƒä¸‹åŸ·è¡Œé€™æ®µcodeï¼Œåœ¨æ²’ç”¨ä»»ä½• **ç«‹å³åŸ·è¡Œå‡½å¼(IIFE)** å°åŒ…ç¨‹å¼ç¢¼ï¼Œ`a` è®Šæ•¸å°‡è¢«è³¦äºˆ `window` ç‰©ä»¶ä¸­ã€‚

> ä¸Šè¿°ä¾‹å­ä½¿ç”¨ `var` å®£å‘Šæœƒè¢«hoistedï¼Œå³åˆ°äº† `window.a` ä¸Šï¼Œåœ¨é€™ç‹€æ³ä¸‹å±¬æ€§æˆ–è®Šæ•¸ `a` çš„å€¼å°±ä¸æœƒè¢«å›æ”¶ï¼Œå› ç‚º `window` ç‰©ä»¶æ˜¯å€‹å¿…é ˆå­˜åœ¨çš„ç‰©ä»¶ã€‚å¯åƒè€ƒ hoisting (æå‡) å’Œ var, let,  const ç›¸é—œèªªæ˜ã€‚

```javascript
a = null;
```

æ­¤æ™‚å°‡ `null` è³¦äºˆ global çš„ `a`ï¼Œ åŸæœ¬è¢«æŒ‡å‘çš„ç‰©ä»¶ `{a: 1}` å°‡æœƒå¾åŸæœ¬çš„ç¯€é»ç§»é™¤ï¼Œ `æ¨™è¨˜å’Œæ¸…ç†æ¼”ç®—æ³•`å°‡å¾ window æ ¹ç›®éŒ„é–‹å§‹åšæƒæï¼Œè‹¥ `{a: 1}` æ²’è¢«å…¶ä»–è®Šæ•¸æˆ–å±¬æ€§åƒè€ƒï¼Œæ­¤ç‰©ä»¶å°‡æœƒè¢«å›æ”¶ã€‚

> âš ï¸ é€™è£¡è¦æœ‰å€‹æ¦‚å¿µæ˜¯ï¼Œå›æ”¶çš„æ˜¯ `{a: 1}` ç‰©ä»¶æœ¬èº«è€Œé `window.a` é€™å€‹å±¬æ€§

> ğŸ’¡ å¾ 2012å¹´é–‹å§‹ï¼Œ JavaScriptå¼•æ“å·²é–‹å§‹æ¡ç”¨`æ¨™è¨˜å’Œæ¸…ç†æ¼”ç®—æ³•`ã€‚ä¹‹å‰èªªçš„ `cycle()` çš„å•é¡Œæ—¢å¯å¾—åˆ°è§£æ±ºï¼Œå› ç‚ºäº’ç›¸åƒè€ƒçš„å•é¡Œä¸æœƒè¢«æ ¹ç›®éŒ„çµ¦è¨˜è¼‰ï¼Œä½†æ­¤æ¼”ç®—æ³•çš„ç¼ºé»æ˜¯å¿…é ˆè¦è®“æ¬²å›æ”¶çš„è®Šæ•¸ç„¡æ³•è¢«æ ¹ç›®éŒ„çµ¦è¨˜è¼‰æ‰èƒ½å°‡å®ƒå›æ”¶ã€‚

ä½†ç¸½çµæ˜¯ï¼Œé€™äº›å›æ”¶é‡‹æ”¾æ©Ÿåˆ¶éƒ½æ˜¯ç”±JavaScriptå¼•æ“æ±ºå®šï¼Œæˆ‘å€‘æ˜¯ç„¡æ³•é€éJavaScriptèªæ³•è§¸ç™¼ä»»ä½•çš„GCæ©Ÿåˆ¶ã€‚

### è¨˜æ†¶é«”å›æ”¶è©²åœ¨ä»€éº¼æ™‚å€™é‹ä½œï¼Œå¾V8å¼•æ“çœ‹çœ‹

é€™äº›æ¼”ç®—æ³•åœ¨ä»€éº¼æ™‚å€™é‹ä½œæ±ºå®šæ–¼ç€è¦½å™¨å¼•æ“ï¼ŸGCä¸å¯èƒ½åœ¨ç€è¦½å™¨é«˜é€Ÿé‹ä½œæ™‚é »ç¹åŸ·è¡ŒGCæ©Ÿåˆ¶ï¼ŒJavaScriptå¼•æ“åŸºæœ¬ä¸Šæœƒç¶“éä»¥ä¸‹ä¸‰é»é€²è¡ŒGCå„ªåŒ–çš„å‹•ä½œï¼š

1. Generational collection ï¼ˆä¸–ä»£é›†åˆï¼‰ï¼š å¯ä»¥ç†è§£æˆ **`è§£æä¸–ä»£çš„ç”¢ç‰©`** ï¼Œå¼•æ“å°‡ç‰©ä»¶åˆ†ç‚ºï¼š `æ–°ç‰©ä»¶` å’Œ `èˆŠç‰©ä»¶` é¡åˆ¥ã€‚ç•¶æŸäº›ç‰©ä»¶å‡ºç¾çš„é »ç‡é«˜ï¼ŒåŸ·è¡Œé€Ÿåº¦è¼ƒçŸ­ä¸”å¾ˆå¿«å°±è„«é›¢ç¯€é»ï¼Œå®ƒå€‘å³æ˜¯ `æ–°ç‰©ä»¶` ï¼Œå¼•æ“æœƒå¿«é€Ÿæª¢æ¸¬ä¸¦å›æ”¶ï¼›ç•¶é‚£äº›ç‰©ä»¶å­˜ç•™çš„æ™‚é–“å¾ˆé•·ï¼Œè¢«å¥—ç”¨çš„é–“è·éé•·ï¼Œé•·ä¹…ä¸‹ä¾†æœƒè¢«å¼•æ“å®šç¾©ç‚º `èˆŠç‰©ä»¶`ï¼Œå¼•æ“å°‡æ¸›å°‘å°é€™é¡å‹çš„ç‰©ä»¶é€²è¡Œæª¢æ¸¬ï¼Œæ¸›å°‘ä¸å¿…è¦çš„æ•ˆèƒ½ã€‚
2. Incremental collection ï¼ˆéå¢é›†åˆï¼‰ï¼šç•¶ä»Šå¤©ç‰©ä»¶çš„é‡æ˜¯å¤šçš„ï¼Œä¸”ç¯€é»æ•¸æ˜¯é«˜çš„ï¼Œå¼•æ“æœƒè©¦åœ–å°‡ç‰©ä»¶æ‹†è§£è™•ç†ï¼Œå°‡ç›¸é—œçš„ç¯€é»æ‹†æˆå€å¡Šå¼åˆ†æï¼Œæ¸›å°‘ç‰©ä»¶éå¤§æ‰€å°è‡´çš„æ•ˆèƒ½çš„éåº¦åˆ©ç”¨ï¼Œå†æŠŠå®ƒå€‘æ¥æˆåŒä¸€ç¯€é»é€²è¡Œåˆ†æï¼Œå¾ä¸­æŠŠä¸å¿…è¦çš„ç¯€é»å›æ”¶ã€‚
3. Idle-time collection ï¼ˆé–’ç½®é›†åˆï¼‰ï¼š å¼•æ“æœƒè©¦è‘—åœ¨ CPU é–’ç½®æœŸé€²è¡Œ GCï¼Œ æ¸›å°‘åœ¨é«˜é‹ä½œæ™‚å€™çš„åŸ·è¡Œé‡ã€‚

GCæ©Ÿåˆ¶æœ‰å¹¾å€‹é‡é»ï¼Œæ•´ç†ä¸€ä¸‹çµ¦å¤§å®¶ï¼š
1. å®ƒæ˜¯æ²’è¾¦æ³•æ‰‹å‹•è§¸ç™¼çš„ï¼Œæˆ‘å€‘æ²’è¾¦æ³•æ§åˆ¶æˆ–é˜»æ­¢å®ƒçš„é‹ä½œã€‚
2. åªè¦è©² `ç‰©ä»¶` æ˜¯å¯ä»¥è¢«ç¯€é»å–çš„ / åˆ°é” `ï¼ˆreachableï¼‰` æ™‚ï¼Œå³æœƒä¿ç•™å®ƒçš„è¨˜æ†¶é«”ç©ºé–“ä¸”ä¸æœƒè¢«å›æ”¶é‡‹æ”¾ã€‚
3. å¯è¢«åƒè€ƒ `ï¼ˆreferencedï¼‰` ä¸ä»£è¡¨å¯è¢«ç¯€é»å–çš„ / åˆ°é” `ï¼ˆreachableï¼‰`ï¼Œå¯è¢«åƒè€ƒçš„ç‰©ä»¶ä¹Ÿæœ‰è¢«å›æ”¶é‡‹æ”¾çš„å¯èƒ½ã€‚

GCæ©Ÿåˆ¶æ˜¯ä¸€å€‹éå¸¸è¤‡é›œä¸”é¾å¤§çš„è­°é¡Œï¼Œæ¯å€‹ç€è¦½å™¨å¼•æ“æ“æœ‰è‡ªå·±è™•ç†å›æ”¶æ©Ÿåˆ¶çš„æ–¹å¼ï¼Œæœ‰èˆˆè¶£çš„äººå¯ä»¥ç ”ç©¶ä¸€ä¸‹ [Chrome V8å¼•æ“è™•ç†GCçš„æ–¹å¼](http://jayconrod.com/posts/55/a-tour-of-v8-garbage-collection)ã€‚


### JavaScriptçš„ `Stack` èˆ‡ `Heap`
åœ¨ç¨‹å¼èªè¨€ä¸–ç•Œè£¡ï¼Œè™•ç†/é…ç½®è¨˜æ†¶é«”çš„æ–¹å¼å¤§è‡´åˆ†ç‚ºä¸€ä¸‹å…©ç¨®åˆ†æ³•ï¼š

1. **`Stack` ï¼ˆå †ç–Šï¼‰**: ç”±ç€è¦½å™¨/ç·¨è­¯å™¨è‡ªè¡Œç®¡ç†çš„è¨˜æ†¶é«”ä½ç½®ï¼Œå®ƒæ“æœ‰è‘—å †ç–Šçš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯ä¸€å±¤å±¤çš„è¨˜æ†¶é«”ï¼Œæ²’è¢«ä½¿ç”¨çš„è¨˜æ†¶é«”è¢«å›æ”¶å°±æœƒå¾å †ç–Šä¸­popå‡ºä¾†ï¼Œå®ƒæ“æœ‰è‘— `LIFO` ï¼ˆå¾Œé€²å…ˆå‡ºï¼‰çš„æ¦‚å¿µï¼š*æƒ³åƒæˆå½±å°æ©Ÿä¸Šçš„ä¸€ç–Šç´™ï¼Œç¬¬ä¸€å€‹è¢«è™•ç†çš„æœƒæ˜¯æœ€ä¸Šå±¤çš„é‚£å¼µç´™*ã€‚
2. **`Heap` ï¼ˆå †ç©ï¼‰**ï¼šåœ¨è¨˜æ†¶é«”ä¸­ç„¡çµæ§‹çš„å¤§å€åŸŸï¼Œå®ƒå€‘æ˜¯åˆ†æ•£çš„ä¸¦ç„¡å †ç–Šçš„æ¦‚å¿µï¼Œåœ¨å…¶ä»–èªè¨€ä¸­å®ƒæ˜¯éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œå›æ”¶çš„ï¼Œåœ¨GCçš„æ¦‚å¿µä¸‹ï¼Œå®ƒé‚„æ˜¯æœƒè¢«ç³»çµ±æ‰€ç®¡ç†ã€‚

é‚£åœ¨JavaScriptä¸–ç•Œè£¡ï¼Œä»€éº¼æ±è¥¿æ˜¯å­˜åœ¨ `Stack` ä»€éº¼æ±è¥¿æ˜¯å­˜åœ¨ `Heap` å‘¢ï¼Ÿ 

èªªçœŸçš„æˆ‘çœ‹äº†å¥½å¤šæ–‡ç« è·ŸV8å¼•æ“çš„æ–‡ä»¶ï¼Œå®ƒä¸¦æ²’æœ‰æ˜ç¢ºçš„å‘Šè¨´ä»€éº¼æ±è¥¿è©²å­˜åˆ°å“ªå€‹è¨˜æ†¶é«”é¡é¡å‹ï¼Œè€Œåœ¨ECMAScriptä¸¦æ²’æœ‰è¦ç¯„è¨˜æ†¶é«”é…ç½®çš„éƒ¨åˆ†ï¼Œæ‰€æœ‰è¨˜æ†¶é«”æ©Ÿåˆ¶éƒ½ç”±Javascriptå¼•æ“æ±ºå®šã€‚

> ğŸ’¡ å°å²¸æ–‡ç« å°‡JavaScriptçš„`åŸºæœ¬å‹åˆ¥`å’Œ`åƒè€ƒå‹åˆ¥`åˆ†åˆ¥æ­¸é¡åœ¨ `å †ç–Š` å’Œ `å †ç©` çš„é…ç½®ï¼Œå¯åƒè€ƒ[æ­¤æ–‡ç« ](https://juejin.im/post/5c8a065c6fb9a049de6e3f2f)ã€‚ä½†å› ç‚ºECMAScriptå’Œç€è¦½å™¨å¼•æ“ä¸¦æ²’æœ‰æ˜ç¢ºè¦ç¯„ä»€éº¼é¡å‹å±¬ä»€éº¼é…ç½®ï¼Œæˆ‘é€™è£¡å°±ä¸æŠŠè©±èªªæ­»äº†ï¼Œç•¢ç«Ÿå®˜æ–¹çš„æ–‡ä»¶æ‰æ˜¯æœ€æœ‰åŠ›çš„è­‰æ“šã€‚

æ‰€ä»¥æˆ‘çš„ç†è§£æ˜¯ï¼šè‹¥JavaScriptè£¡é¢æ‰€æœ‰æ±è¥¿éƒ½æ˜¯**ç‰©ä»¶**çš„è©±ï¼Œé‚£å°±æ˜¯å­˜åœ¨ `Heap`ï¼›å› JavaScriptæ˜¯å€‹å‹•æ…‹èªè¨€ï¼Œç•¶ä»–æ˜¯å€‹å‹•æ…‹å‹åˆ¥æ™‚ï¼Œå¼±å‹åˆ¥å°è‡´å®ƒå­˜æ”¾åœ¨ `Stack` çš„æ„ç¾©å°±æ²’äº†ï¼Œå› ç‚ºå‹åˆ¥å¸¸è¢«ä¿®æ”¹çš„ç‹€æ³ä¸‹ï¼Œè¦å¾ä¸€å †ç´™ä¸­å°‹æ‰¾è©²è¨˜æ†¶é«”ä½ç½®å†ä¿®æ”¹å®ƒå°±è®Šå¾—å¤ªæ²’æ•ˆç‡äº†ã€‚ä»¥æˆ‘å€‘ä¸Šé¢è¨è«–çš„GCæ©Ÿåˆ¶ï¼Œçš„ç¢ºå­˜åœ¨ `Heap` æœƒæ˜¯æ¯”è¼ƒå¥½è¢«å›æ”¶é‡‹æ”¾æ‰ã€‚

ä½†JavaScriptæœ‰äº‹ä»¶åŸ·è¡Œç·’çš„æ©Ÿåˆ¶ï¼Œä¹Ÿå°±æ˜¯åœ¨æŸå€‹æ™‚é–“é»å‘¼å«äº†ä»€éº¼å‡½å¼ï¼Œè€Œé€™å‡½å¼æ˜¯éœ€è¦å‘¼å«å¤šå€‹å‡½å¼åšå †ç–Šçš„å‹•ä½œï¼Œä»–å€‘å°±æœƒæœ‰å…ˆå¾Œé †åºçš„å•é¡Œï¼Œé€™æ™‚å€™å°±å‡½å¼æœ¬èº«å°±æœƒçµ„æˆ `stack` ã€‚æƒ³è¦æ›´äº†è§£JavaScriptçš„åŸ·è¡Œç·’å¯ä»¥åƒè€ƒ MDN çš„ [Event Loop](https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop) æ–‡ç« æˆ–æ˜¯ Philip Roberts åœ¨2014å¹´ JSConfçš„Event Loop[æ¼”è¬›](https://www.youtube.com/watch?v=8aGhZQkoFbQ)ã€‚

> âš ï¸ Event Loopå…§æåˆ°çš„ `heap` è·Ÿ `stack` èˆ‡JavaScriptæ˜¯å¦ä½¿ç”¨å“ªç¨®è¨˜æ†¶é«”å­˜å–è³‡æ–™æˆ–è¨±æ²’æœ‰ç›´æ¥é—œä¿‚ã€‚

### è¨˜æ†¶é«”æ´©æ¼ Memory Leak in JavaScript
æ¥ä¸‹ä¾†æˆ‘å€‘ä¾†æ¢è¨åœ¨JavaScriptè£¡é¢æœƒç™¼ç”Ÿçš„è¨˜æ†¶é«”æ´©æ¼å•é¡Œã€‚ä»€éº¼æ˜¯è¨˜æ†¶é«”æ´©æ¼ï¼Œç•¶ä½ çš„ç€è¦½å™¨éå¸¸ç•¶çš„æ™‚å€™å¤§æ¦‚æœ‰87%éƒ½æ˜¯è¨˜æ†¶é«”æ´©æ¼å°è‡´çš„ã€‚æ²’åœ¨ç”¨çš„è®Šæ•¸ä½†å»è¢«å­˜å–è€Œ`æ²’è¾¦æ³•`è¢«å›æ”¶é‡‹æ”¾ï¼Œé€šå¸¸éƒ½æ˜¯å› ç‚ºæŸäº›æ’°å¯«JavaScriptçš„å£ç¿’æ…£ï¼š

#### ä¸å¿…è¦çš„å…¨åŸŸè®Šæ•¸

ä¾æ“šå‰›å‰›`æ¨™è¨˜å’Œæ¸…ç†æ¼”ç®—æ³•`ä¸­æ¢è¨çš„ï¼Œç•¶æˆ‘å€‘ä¸å°æŠŠè®Šæ•¸å€¼è³¦äºˆ `window` æ ¹ç›®éŒ„ä¸‹ï¼Œé™¤éä½ å°‡å®ƒè¨­æˆ `null`ï¼Œä¸ç„¶é€™è¨˜æ†¶é«”ä½ç½®æ°¸é éƒ½ä¸æœƒè¢«å›æ”¶é‡‹æ”¾ã€‚æœ‰æ™‚å€™æ˜¯ç„¡æ„çš„ï¼Œå› æ²’æ³¨æ„è€Œä¸å°å¿ƒè¨­æˆå…¨åŸŸè®Šæ•¸ï¼Œä¾‹å¦‚ä»¥ä¸‹çš„æ’°å¯«ï¼š

```javascript 
function setLocalState(data) {
  state = data;
}
```
é€™è£¡çš„ `state` å°±ä¸å°å¿ƒè®Šæˆäº† `window.state` äº†ï¼Œæ„å¤–çš„è®Šæˆäº†å…¨åŸŸè®Šæ•¸ã€‚

> ğŸ’¡ JavaScriptè£¡æœ‰å€‹ `immutable` æ¦‚å¿µï¼Œå³ç›¡é‡ä¸è¦ç›´æ¥ä¿®æ”¹åƒæ•¸æˆ–è®Šæ•¸çš„å€¼ï¼Œä»¥ä¸Šçš„ä¾‹å­æ”¹æˆ `pure function` ä¹Ÿå¯ä»¥é¿å…è¨˜æ†¶é«”æ´©æ¼çš„å•é¡Œã€‚

> ğŸ’¡ åœ¨JavaScriptæœ‰å€‹å°æŠ€å·§å¯ä»¥é¿å…ä¸å°å¿ƒè¨­å®šå…¨åŸŸè®Šæ•¸çš„å•é¡Œï¼šè¨­å®š `use-strict;` ï¼›å•Ÿç”¨åš´æ ¼æ¨¡å¼è§£æ JavaScriptï¼Œå¯é˜²æ­¢ä¸å°å¿ƒæ±¡æŸ“å…¨åŸŸè®Šæ•¸è£¡çš„å€¼ã€‚

å¦å¤–é‚„æœ‰è·Ÿ **`this`** çš„ **åŸ·è¡Œå€åŸŸ `ï¼ˆexecution contextï¼‰`** æœ‰é—œï¼Œå¦‚ï¼š
```javascript 
function setLocalState(data) {
  this.state = data;
}
setLocalState('global'); // window.state = 'global';

const a = {
  state: null,
  setLocalState: setLocalState
}
a.setLocalState('local'); // window.state = undefined;
```
æ‰€ä»¥åœ¨ä½¿ç”¨ `this` æ™‚å€™è¦å°å¿ƒåŸ·è¡Œçš„å€åŸŸï¼Œå…¨åŸŸè®Šæ•¸ä¸æœƒè¢«å›æ”¶ï¼Œé™¤éé‡æ–°è³¦äºˆè©²å€¼æˆ–æ”¹æˆ `null`ï¼Œæ‰èƒ½æº–ç¢ºçš„å›æ”¶ä¸å¿…è¦çš„ç‰©ä»¶ã€‚
```javascript
window.state = null;
```
> ğŸ’¡ ä½¿ç”¨ `(iife)()` ç«‹å³åŸ·è¡Œå‡½å¼ä¹Ÿå¯ä»¥é¿å…å…¨åŸŸè®Šæ•¸çš„æ±¡æŸ“ã€‚

#### Clousure
JavaScriptè£¡å¸¸ç”¨çš„é–‰åŒ…æ¨¡å¼ï¼Œä¹Ÿæœƒå°è‡´è¨˜æ†¶é«”æ´©æ¼ï¼Œæˆ‘é€™è£¡ä¸ç´°èªªé–‰åŒ…çš„é‹ä½œåŸç†å’Œæ–¹å¼ï¼Œç°¡è€Œè¨€ä¹‹é–‰åŒ…å°±æ˜¯è¨˜è¼‰ä¸¦å­˜å–æŸå€‹è®Šæ•¸è€Œè®“é€™è®Šæ•¸ç¯„ç–‡æ˜¯å°é–‰åœ¨ä¸€å€‹ç’°å¢ƒä¸­ã€‚

å…¶å¯¦æˆ‘è¦ºå¾—é–‰åŒ…æ˜¯ä¸€å€‹æœ€ç›´æ¥è®“è¨˜æ†¶é«”ç„¡æ³•é‡‹æ”¾çš„æ’°å¯«æ¨¡å¼ï¼Œå› ç‚ºè¨˜è¼‰äº†æŸå€‹å°é–‰å¼çš„è®Šæ•¸ï¼Œé€™è®Šæ•¸å¿…é ˆè¦é€éæ·±åº¦è§£ææ‰èƒ½çŸ¥é“å¾ŒçºŒçš„ç¨‹å¼æ˜¯å¦æœ‰ä½¿ç”¨æˆ–åƒè€ƒï¼Œè€Œé–‹ç™¼è€…ä¹Ÿå®¹æ˜“åœ¨ç„¡æ„ä¸­æ’°å¯«äº†å°è‡´è¨˜æ†¶é«”æ´©æ¼çš„é–‰åŒ…ç¨‹å¼ã€‚

```javascript
var theThing = null;

var replaceThing = function () {
  var originalThing = theThing;
  var unused = function () {
    if (originalThing) console.log('hi');
  };
  theThing = {
    longStr: new Array(1000000).join('*'),
    someMethod: function () {
        console.log('message');
    }
  };
};

replaceThing();
```
`replaceThing` å‡½å¼åŸ·è¡Œå®Œå¾Œï¼Œè¨˜æ†¶é«”ç„¡æ³•å›æ”¶ï¼Œé€™å€‹ç¯„ä¾‹æ¯”è¼ƒè¤‡é›œï¼Œæˆ‘å€‘æ‹†è§£è§£é‡‹å¥½äº†ï¼š

1. ç•¶ `replaceThing` è¢«å‘¼å«å¾Œï¼Œ`theThing` æœƒå–å¾—ç‰©ä»¶å« `longStr` å’Œ `someMethod()`ã€‚
2. `originalThing` è¢« `unused` é–‰åŒ…ä½œç”¨åŸŸçµ¦é™åˆ¶ï¼Œå› ç‚ºç¬¬å››è¡Œçš„ `originalThing = theThing` ï¼Œä½œç”¨åŸŸå·²è¢«å…±äº«ï¼Œå³ä½¿ `unused` æ°¸é ä¸æœƒè¢«èª¿ç”¨ï¼Œä½†å·²è¢« `theThing` æ‰€æŒ‡å‘çš„é–‰åŒ…çµ¦åƒè€ƒäº†ã€‚
3. å¾ŒçºŒå¦‚æœæ²’æœ‰ `theThing` è¨­æˆ `null`ï¼Œ é–‰åŒ…å…§çš„å‡½å¼å³ä½¿æ²’è¢«ä½¿ç”¨ä¹Ÿéƒ½ä¸æœƒè¢«GCæ©Ÿåˆ¶å›æ”¶ã€‚
4. è‹¥ä¹‹å¾Œå†èª¿ç”¨ `replaceThing` å‡½å¼ï¼Œ é–‰åŒ…çš„å‡½å¼åªæœƒè®Šå¾—æ›´å¤§ï¼Œè¨˜æ†¶é«”ç©ºé–“æœƒå¾€ä¸Šæå‡ã€‚

```javascript
window.onload = function() {
  var obj = document.getElementById("element");
  obj.onclick = function leak() {}; // é€™å€‹æ˜¯å…‡æ‰‹
}
```
ä»¥ä¸Šç¨‹å¼ç¢¼åŒ…å«äº†é–‰åŒ…å’Œå¾ªç’°æŒ‡å‘åƒè€ƒï¼š

1. `obj` åŒ…å«äº† DOM ç‰©ä»¶åƒè€ƒï¼Œä½†é é¢ä¸­çš„ `<div id="element">button</div>` ä¹ŸåŒ…å«äº†ç‰©ä»¶ `obj` çš„åƒè€ƒï¼Œå½¢æˆäº†äº’ç›¸åƒè€ƒçš„å¾ªç’°ã€‚
2. å‡½å¼å…§åŒ…å«å‡½å¼æœƒå½¢æˆé–‰åŒ…ï¼Œç•¶è¢«èª¿ç”¨çš„æ™‚å€™å°±æœƒæ²’è¾¦æ³•å¾—åˆ°é‡‹æ”¾ã€‚

```javascript
//è§£æ±ºè¾¦æ³•
window.onload = function() {
  var obj = document.getElementById("element");
  obj.onclick = leak; // as outside reference
}
function leak() {}

// or

window.onload = function() {
  (function() {
    var obj = document.getElementById("element");
    obj.onclick = leak;
  }());
  function leak() {}
}
```
å‡½å¼å®šç¾©åœ¨å‡½å¼å¤–æˆ–ä½¿ç”¨ç«‹å³åŸ·è¡Œå‡½å¼å³å¯è§£é™¤é–‰åŒ…ã€‚


#### åˆ©ç”¨ç‰©ä»¶å­˜å–DOMæ¨™ç±¤
æœ‰æ™‚å€™åˆ©ç”¨ç‰©ä»¶å­˜å–DOMç¯€é»æœƒè®“ç¨‹å¼æ¯”è¼ƒå¥½ç®¡ç†ï¼Œä¾‹å¦‚
```javascript
let allEls = {
  button: document.querySelector('button');
  div: document.querySelector('div');
};

function deleteButton() {
  document.body.removeChild(document.querySelector('button'));
}

deleteButton();
```

ç•¶ `deleteButton` è¢«åŸ·è¡Œå¾Œæœƒåˆªé™¤ç¯€é»ä¸Šçš„ button æŒ‰éˆ•ï¼Œä½† `allEls` è£¡é‚„æœ‰è¨˜è¼‰ç‰©ä»¶çš„åƒè€ƒï¼Œå› æ­¤ `button` æ¨™ç±¤è¨˜æ†¶é«”åƒè€ƒç„¡æ³•è¢«å›æ”¶é‡‹æ”¾ã€‚

ç‚ºäº†è§£æ±ºé€™å•é¡Œï¼ŒECMAScript 2015è¦ç¯„æä¾›äº† `WeakSet` å’Œ `WeakMap` çš„ç‰©ä»¶å‹åˆ¥ï¼Œä»–å€‘é‡å°å€¼çš„åƒè€ƒæ˜¯ä¸è¨ˆå…¥å›æ”¶æ©Ÿåˆ¶æ‰€é™åˆ¶ï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹ä»¥ä¸‹çš„ä¾‹å­ï¼š

```javascript
const weakMap = new WeakMap();
const button = document.querySelector('button');

weakMap.set(element, 'button');
```
`Weak` ä¸€è©ä»£è¡¨å¼±å¼•ç”¨ï¼Œä¸€æ—¦DOMç¯€é»è¢«æ¶ˆé™¤ï¼Œå®ƒæ‰€ä½”æœ‰çš„è¨˜æ†¶é«”å³è¢«å›æ”¶é‡‹æ”¾ï¼ŒweakMapä¿ç•™çš„å€¼ä¹ŸæœƒåŒæ™‚æ¶ˆå¤±ã€‚ç›¸é—œWeakMapçš„åƒè€ƒå¯ä»¥çœ‹[MDNçš„æ–‡ç« ](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap)ã€‚

> By contrast, native WeakMaps hold "weak" references to key objects, which means that they do not prevent garbage collection in case there would be no other reference to the key object. 

#### setInterval is `Evil` - å¾ªç’°è™•ç†
è¨ˆæ™‚å™¨æ˜¯ç¨‹å¼è£¡å¸¸ç”¨çš„åŠŸèƒ½ï¼Œä½†å®ƒæŸç¨®ç¨‹åº¦ä¹Ÿæœƒè¢«é–‰åŒ…çš„ä½œç”¨åŸŸçµ¦é™åˆ¶ï¼Œçœ‹çœ‹ä»¥ä¸‹ä¾‹å­ï¼š

```javascript
let myData = { a: 1 };

setInterval(function() {
  let element = document.getElementById('element');
  if(element) {
    element.innerHTML = JSON.stringify(myData));
  }
}, 1000);
```
1. ä¸Šè¿°codeä¸­`element`è‹¥è¢«åˆªé™¤ ï¼Œè¨ˆæ™‚å™¨æ˜¯ä¸æœƒåœæ­¢çš„ã€‚
2. å› è¨ˆæ™‚å™¨æ²’åœæ­¢ï¼Œåœ¨å‡½å¼å…§èª¿ç”¨äº† `myData` å€¼ï¼Œæ‰€ä»¥å³ä½¿ `myData` ä¹‹å¾Œæ²’è¢«ä½¿ç”¨äº†ï¼Œå®ƒä»ç„¶æ²’è¾¦æ³•è¢«å›æ”¶é‡‹æ”¾ã€‚

```javascript
//è§£æ±ºè¾¦æ³•
let myData = { a: 1 };

function setData() {
  let element = document.getElementById('element');
  if(element) {
    element.innerHTML = JSON.stringify(myData));
  }
}

setInterval(setData, 1000); // as references

...
// æŸå€‹æ™‚é–“é»å¾Œ
clearInterval(setData, 1000);
```
#### äº‹ä»¶ç›£è½ èˆ‡ Component Based Framework
äº‹ä»¶ç›£è½ä¹Ÿæ˜¯ä¸€å€‹å¸¸è¢«éºå¿˜ä¸”å®¹æ˜“å°è‡´è¨˜æ†¶é«”æ´©æ¼çš„åŸå› ä¹‹ä¸€ã€‚è‹¥æ¨™ç±¤å…ƒç´ è¢«å®šç¾©æŸ **äº‹ä»¶ç›£è½ `ï¼ˆaddEventListenerï¼‰`** æ™‚ï¼Œæ¨™ç±¤å…ƒç´ è‹¥è¢«ç§»é™¤å€™è¦è¨˜å¾—ç§»é™¤åŸæœ¬çš„ç›£è½ `ï¼ˆremoveEventListenerï¼‰`ï¼Œ å› ç‚ºé€™ä¾‹å­æ¯”è¼ƒç°¡å–®æ‰€ä»¥å°±ä¸æä¾›ç¯„ä¾‹äº†ã€‚

å›æƒ³ç¾ä»£æ¡†æ¶éƒ½æœƒé‹ç”¨å…ƒä»¶åŒ–è¨­è¨ˆä»¥åŠSPAå½¢å¼çš„é‹ä½œé‚è¼¯ï¼Œé é¢æ˜¯ä¸åš**åˆ·æ–°**çš„å‹•ä½œï¼Œå¿˜äº†åˆªé™¤æˆ–ç§»é™¤æŸäº›ç›£è½æ©Ÿæœƒå°è‡´è¨˜æ†¶é«”ä½”ç”¨ç‡å¾€ä¸Šéå¢ï¼Œè¨˜æ†¶é«”æ´©æ¼çš„æ©Ÿç‡å°±æœƒè®Šå¾—å¾ˆé«˜ã€‚ä¸ç®¡æ˜¯è‡ªå·±å¯«çš„æ‡‰ç”¨ç¨‹å¼æˆ–æ˜¯ç¬¬ä¸‰æ–¹æä¾›çš„å¥—ä»¶ï¼Œéƒ½æœƒæœ‰è¨˜æ†¶é«”æ´©æ¼çš„é¢¨éšªï¼Œä¾‹å¦‚æœ€è¿‘è »æµè¡Œçš„ `element-ui` å¤§å‹é–‹æºå¥—ä»¶ä»æœ‰æ­¤[å•é¡Œ](https://github.com/ElemeFE/element/issues?utf8=%E2%9C%93&q=memory+leak)ã€‚

å¥—ä»¶æœ¬èº«åœ¨è¨­è¨ˆçš„æ™‚å€™éƒ½æœƒç‰¹åˆ¥é‡å°ä»¥ä¸Šçš„å¹¾é»å¯èƒ½å°è‡´è¨˜æ†¶é«”æ´©æ¼çš„åšå„ªåŒ–ï¼Œä¾‹å¦‚ `highcharts-vue`ï¼Œæœƒåœ¨å…ƒä»¶éŠ·æ¯€æ™‚é‡å° `highcharts` åš `destroy` çš„å‹•ä½œã€‚ [é€£æ¥](https://github.com/highcharts/highcharts-vue/blob/5ce9ee5c3e81a83e78b1df3e333de6894bd8710f/src/component.js#L53)

```javascript
// å–ä¹‹ highcharts-vue src/component.js
...

mounted () {
  let HC = this.highcharts || Highcharts
  // Check wheather the chart configuration object is passed, as well as the constructor is valid
  if (this.options && HC[this.constructorType]) {
    this.chart = HC[this.constructorType](
      this.$refs.chart,
      copyObject(this.options, true), // Always pass the deep copy when generating a chart. #80
      this.callback ? this.callback : null
    )
  } 
  ...
},
beforeDestroy () {
  // Destroy chart if exists
  if (this.chart) {
    this.chart.destroy()
  }
}
```

ä»¥Vueå‰ç«¯æ¡†æ¶ç‚ºä¾‹ï¼Œ`@click` äº‹ä»¶ç›£è½å°‡æœƒéš¨è‘—å…ƒä»¶éŠ·æ¯€æ™‚å€™å°‡æ‰€é‹ç”¨çš„ç›£è½çµ¦åˆªé™¤éŠ·æ¯€ï¼Œä½†å¾€å¾€åœ¨æ’°å¯«é€™é¡å‹çš„codeæ™‚å€™æœƒå¿½ç•¥åŸç”ŸJavaScriptçš„ç›£è½äº‹ä»¶ï¼š

```html
<div class="container">
  <button class="length">Check Length</button>
  <div id="#app">
    <Todo v-for="todo in todos" />
  </div>
</div>

<script>
Vue.component('Todo', {
  template: '<button>{{name}} <span @click="removeTodo"> X </span></button>',
  methods: { /* çœç•¥ */ },
  mounted() {
    document.querySelector('length').addEventListener('click', () => {
      alert('ç›®å‰æœ‰' + this.$parent.todos.length  + ' Todo');
    });
  }
});

new Vue({
  el: '#app',
  data: {
    todos: [/* å“†å“†å“†å“†å“†å“†å“† */]
  }
})
</script>
```
ç•¶ `<Todo />` æŒ‰ä¸‹ `removeTodo` æ™‚å€™ï¼Œæ¡†æ¶æœƒå¹«æˆ‘å€‘æŠŠ `removeTodo` çš„ clickäº‹ä»¶ä¹Ÿä¸€ä½µç§»é™¤ï¼Œä½†æ˜¯æ‰‹å‹•ç›£è½åŸ·è¡Œçš„ `length` å‰‡ä¸æœƒè¢«ç§»é™¤ï¼Œè€Œä¸”å¾ŒçºŒæ–°å¢é€²ä¾†çš„ todo å°‡æœƒè¦†è“‹ N å±¤çš„ `call stack`ã€‚

> é›–ç„¶é€™æ¡ˆä¾‹æ¯”è¼ƒæ¥µç«¯ä¹Ÿä¸å¯èƒ½æœƒé€™éº¼å¯«ï¼Œä½†å–®ç´”æè¿°å¿˜äº†è§£é™¤ç›£è½é€™ä»¶äº‹æƒ…è¶³å¤ å°è‡´è¨˜æ†¶é«”æ´©æ¼çš„å•é¡Œã€‚



//TODO